#!/usr/bin/env bash
# shellcheck disable=SC1091,SC1090

# Find the name of the folder the scripts are in
SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"

CONFIG_FILE="$SCRIPT_DIR"/config/setup.conf
FUNC_FILE="$SCRIPT_DIR"/config/shared
LOG="$SCRIPT_DIR"/main.log
[[ -f "$LOG" ]] && rm -f "$LOG"

source_file() {
    if [[ -f "$1" ]]; then
        source "$1"
    else
        echo "ERROR! Missing file: $1"
        exit 0
    fi
}

sequence() {
    echo -ne "Starting ASAI...\n"
    source_file "$CONFIG_FILE"
    . "$SCRIPT_DIR"/scripts/0-preinstall
    arch-chroot "$MOUNTPOINT" /root/asai/scripts/1-setup
    arch-chroot "$MOUNTPOINT" /usr/bin/runuser -u "$USERNAME" -- /home/"$USERNAME"/asai/scripts/2-user
    arch-chroot "$MOUNTPOINT" /root/asai/scripts/3-postinstall
    logo
    title "Done - Please Eject Install Media and Reboot"

}

source_file "$FUNC_FILE"
clear
logo
background_checks
title "Scripts are in directory named asai"
. "$SCRIPT_DIR"/scripts/startup
sequence |& tee "$LOG"
end
